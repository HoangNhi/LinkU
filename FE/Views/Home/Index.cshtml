@{
    ViewData["Title"] = "Trang chủ";
    MODELS.USER.Dtos.MODELUser User = ViewBag.UserInfo;
}

<style>
    .text-Functions {
        font-weight: 500;
        color: black;
        font-size: 14px;
        text-transform: none;
        padding: 10px 0;
        text-align: start
    }

    .icon-Functions {
        padding: 12px 12px 12px 4px;
        color: black;
        font-size: 20px
    }

    .btn-Functions {
        margin: 2px 0;
        padding: 0px 8px;
        width: 100%;
    }

    .btn-Functions:hover,
    .btn-ProfilePicture:hover {
        background-color: rgba(0,0,0,0.04);
    }

    .btn-Functions.active {
        background-color: rgba(0,0,0,0.06);
        border-radius: 8px;
        pointer-events: none;
    }

    /*::-webkit-scrollbar {
        width: 12px;
    }*/

    /* Track */
    #Functions-container::-webkit-scrollbar-track:hover {
        -webkit-box-shadow: none;
    }

    /*Handle*/
    #Functions-container::-webkit-scrollbar-thumb {
        -webkit-box-shadow: none
    }

    #MessageList {
        max-height: 100%;
        min-height: 0;
        width: unset;
        max-width: 480px;
        min-width: 300px;
        margin-left: 16px;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0px 0px 8px rgba(52, 72, 84, .05);
        display: flex;
        flex: 2;
    }

    #Messages {
        max-height: 100%;
        min-height: 0;
        width: unset;
        max-width: 100%;
        min-width: 300px;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0px 0px 8px rgba(52, 72, 84, .05);
        margin-left: 16px;
        display: flex;
        flex: 3;
    }

    .btn.btn-light.rounded-circle{
        background-color: rgba(211, 212, 213, 0.6)
    }

    .btn.btn-light.rounded-circle:hover{
        background-color: rgba(211, 212, 213, 1)!important 
    }

    #MessageList_SearchInput {
        padding: 4px 12px 4px 2px;
        border: 0;
        font-size: .9375rem;
        font-size: 15px;
        height: 36px;
        background-color: rgba(0,0,0,0)
    }

    #MessageList_SearchInput:focus-visible {
        outline: none;
        box-shadow: none;
    }

</style>

<div class="d-flex"
     style="background-color: rgb(245, 245, 245); height: calc(100vh - 32px)">
    <!-- Chức năng -->
    <div id="Functions" style="width: 240px; min-width: 240px">
        <div>
            <button type="button"
                    class="btn btn-link d-flex align-items-center btn-Functions active"
                    data-mdb-ripple-init
                    data-mdb-ripple-color="dark">
                <i class="fa-solid fa-comment icon-Functions"
                   style=""></i>
                <span class="text-Functions">Đoạn chat</span>
            </button>

            <button type="button"
                    class="btn btn-link d-flex align-items-center btn-Functions"
                    data-mdb-ripple-init
                    data-mdb-ripple-color="dark">
                <i class="fa-solid fa-comment-dots icon-Functions"></i>
                <span class="text-Functions">Tin nhắn đang chờ</span>
            </button>

            <button type="button"
                    class="btn btn-link d-flex align-items-center btn-Functions"
                    data-mdb-ripple-init
                    data-mdb-ripple-color="dark">
                <i class="fa-solid fa-user-group icon-Functions"></i>
                <span class="text-Functions">Lời mời kết bạn</span>
            </button>
        </div>
        <!-- Tên và sidenav -->
        <div id="ProfilePicture"
             style="padding-top: 12px; bottom: 12px; width: 100%; max-width: 240px; background-color: rgb(245, 245, 245)"
             class="d-flex align-items-center position-fixed">
            <button type="button"
                    class="btn btn-link btn-ProfilePicture"
                    data-mdb-ripple-init
                    data-mdb-ripple-color="dark"
                    style="padding: 6px; width: 80%; text-align: left; display: flex; align-items: center">
                <img id="Img-ProfilePicture"
                     class="rounded-circle"
                     src="@User.ProfilePicture"
                     width="32" height="32"
                     style="margin: 0 6px" />
                <span id="Name-ProfilePicture"
                      style="text-transform: none; font-size: 14px; font-weight: 500; color: black">@User.Ten</span>
            </button>
            <div id="SideNav"
                    style="width: 20%; text-align: center">
                <button type="button"
                        class="btn btn-light rounded-circle"
                        data-mdb-ripple-init
                        data-mdb-ripple-color="dark"
                        style="padding: 9px"
                        onclick="ChangeWidthSideNav()">
                    <img src="~/asset/hide.png"
                            width="20" height="20" />
                </button>
            </div>
        </div>
    </div>

    <!-- Danh sách tin nhắn -->
    <div id="MessageList">
        <div class="card text-center flex-grow-1">
            @* Header *@
            <div class="card-header d-flex justify-content-between align-items-center flex-column border-bottom-0"
                 style="padding: 6px 12px">
                <div class="d-flex justify-content-between align-items-center w-100"
                     style="">
                    <span style="font-size: 1.5rem; font-weight: 700; color: black; line-height: 28px">
                        Đoạn chat
                    </span>
                    <button type="button"
                            class="btn btn-light rounded-circle"
                            data-mdb-ripple-init
                            data-mdb-ripple-color="dark"
                            style="padding: 9px; margin: 6px">
                        <i class="fa-regular fa-pen-to-square" style="font-size: 20px; color: black"></i>
                    </button>
                </div>
                <div class="d-flex w-100">
                    <button id="MessageList_Back"
                            type="button"
                            class="btn btn-light rounded-circle d-none"
                            data-mdb-ripple-init
                            data-mdb-ripple-color="dark"
                            style="margin-right: 4px; padding: 8px 9.25px; line-height: 1; background-color: rgba(0,0,0,0)"
                            onclick="returnMessageListScreen()">
                        <i class="fa-solid fa-arrow-left" 
                           style="color: black; font-size: 20px"></i>
                    </button>
                    <div class="d-flex w-100 align-items-center"
                         style="background-color: rgba(134, 142, 153, .1); border-radius: 50px; overflow: hidden">
                        <i class="fas fa-search"
                           style="padding: 0 4px 0 14px; line-height: 36px; background-color: rgba(0,0,0,0)"></i>
                        <input id="MessageList_SearchInput"
                               class="w-100"
                               type="text"
                               placeholder="Tìm kiếm"
                               autocomplete="off"
                               oninput="searchMessage()">
                    </div>
                </div>
            </div>
            @* Body *@
            <div id="MessageList_Body"
                 class="card-body"
                 style="padding: 6px; height: calc(100vh - 126px); overflow-x: hidden; overflow-y: auto">
                Danh sách tin nhắn
            </div>
        </div>
    </div>

    <!-- Tin nhắn -->
    <div id="Messages">
        <div class="card text-center flex-grow-1">
            <div class="card-header">Featured</div>
            <div class="card-body">
                Message - Tin nhắn
            </div>
            <div class="card-footer text-muted">2 days ago</div>
        </div>
    </div>
</div>


<script>
    $(document).ready(function () {
        // Thay đổi giao diện khi lần đầu truy cập vào trang
        changeWidthFocusScreen();

        // Xử lý sự kiện MessageList_Search
        $("#MessageList_SearchInput").on('focus', function () {
            if ($("#MessageList_Back").hasClass("d-none")) {
                $("#MessageList_Back").removeClass("d-none");
                $("#MessageList_Body").html('<div id="MessageList_SearchResult"></div>')
            }
        });

        //$("#MessageList_SearchInput").on('blur', function () {
        //    $("#MessageList_Back").addClass("d-none")
        //});
    });

    // Hiển thị
    $(window).on('resize', function () {
        changeWidthFocusScreen();
    });

    // Xử lý sự kiện chuyển button
    const buttons = document.querySelectorAll('.btn-Functions');

    // Thêm sự kiện click cho từng button
    buttons.forEach(button => {
        button.addEventListener('click', () => {
            // Loại bỏ class .active khỏi tất cả các button
            buttons.forEach(btn => btn.classList.remove('active'));

            // Thêm class .active cho button vừa được click
            button.classList.add('active');
        });
    });

    function ChangeWidthSideNav() {
        const width = $("#Functions").width()
        // Change Flex dir
        const ProfilePicture = document.querySelector("#ProfilePicture");
        const currentDirection = ProfilePicture.style.flexDirection;
        ProfilePicture.style.flexDirection = (currentDirection === "row" || currentDirection === "") ? "column" : "row";

        if (width == 44) {
            $("#Functions").width(240)
            $("#Functions").css("min-width", "240px")
            $("#ProfilePicture").width(240)
            const Functions = document.querySelector("#Functions")
            Functions.style.width = "240px"
            const ProfilePicture = document.querySelector("#ProfilePicture")
            ProfilePicture.style.width = "100%"
            // Show title
            const elements = document.querySelectorAll(".text-Functions");
            elements.forEach(element => {
                element.style.display = "block";
            });
            const NameProfile = document.querySelector("#Name-ProfilePicture")
            NameProfile.style.display = "inline";
            // Add margin
            const ImgProfile = document.querySelector("#Img-ProfilePicture")
            ImgProfile.style.margin = "0 6px";
            // Change Width
            const BtnProfilePicture = document.querySelector(".btn-ProfilePicture")
            BtnProfilePicture.style.width = "80%"
            const SideNav = document.querySelector("#SideNav")
            SideNav.style.width = "20%"
        } else {
            $("#Functions").width(44)
            $("#Functions").css("min-width", "44px")
            $("#ProfilePicture").width(44)

            // Hide title
            const elements = document.querySelectorAll(".text-Functions");
            elements.forEach(element => {
                element.style.display = "none";
            });
            const NameProfile = document.querySelector("#Name-ProfilePicture")
            NameProfile.style.display = "none";
            // Remove margin
            const ImgProfile = document.querySelector("#Img-ProfilePicture")
            ImgProfile.style.margin = "0";
            // Change Width
            const BtnProfilePicture = document.querySelector(".btn-ProfilePicture")
            BtnProfilePicture.style.width = "100%"
            const SideNav = document.querySelector("#SideNav")
            SideNav.style.width = "100%"
        }
    }

    // Lấy ra vùng đang được Focus
    // 1: MessageList
    // 2: Messages
    function getFocusScreen() {
        return 1;
    }

    function changeWidthFocusScreen() {
        // Max width - 900
        if ($(window).width() < 900 && $("#Functions").width() > 44) {
            ChangeWidthSideNav();
        }

        // Màn hình MessageList và Messages
        if ($(window).width() < 700) {
            if (getFocusScreen() == 1) {
                $("#MessageList").show()
                $("#MessageList").css("max-width", "100%")
                $("#MessageList").css("width", "100%")
                $("#Messages").hide()
            } else {
                $("#MessageList").hide()
                $("#Messages").show()
                $("#Messages").css("max-width", "100%")
                $("#Messages").css("width", "100%")
            }
        } else {
            $("#MessageList").show()
            $("#Messages").show()
            // Reset css
            $("#MessageList").css("max-width", "480px")
            $("#MessageList").css("width", "unset")
            $("#Messages").css("max-width", "100%")
            $("#Messages").css("width", "unset")
        }

        // Button SideNav
        if ($(window).width() < 590) {
            $("#SideNav").hide();
        } else {
            $("#SideNav").show();
        }
    }

    function returnMessageListScreen() {
        $("#MessageList_Back").addClass("d-none")
        $("#MessageList_SearchInput").val("")
    }

    function searchMessage() {
        var textSearch = $("#MessageList_SearchInput").val()
        if (textSearch === "") {
            $("#MessageList_Body").html('<div id="MessageList_SearchResult"></div>')
        } else {
             showLoading(true)
             $.ajax({
                 url: "@Url.Action("Search", "MessageList")",
                 type: "POST",
                 data: {
                     TextSearch: textSearch
                 },
                 success: function (response) {
                     showLoading(false)
                     if (response.isSuccess === undefined) {
                         $("#MessageList_SearchResult").html(response)
                     } else {
                         ShowThongBaoThatBai(response.message)
                     }
                 },
                 error: function (xhr, error) {
                     showLoading(false)
                     ShowThongBaoThatBai(error)
                 }
             })
        }

    }
</script>
